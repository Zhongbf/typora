# B 树和B+树

## 一、 B树

#### 1.1 B树的定义

B树，又称为多路平衡查找树，B树种所有结点的孩子个数（子树）的最大值称为B树的阶，通常用 m 表示。一颗 m 阶 B 树或为空树，或为满足如下特性的 m 叉树

1. 树中每个结点至多有 m 棵子树，即至多含有 m - 1 个关键字

2. 若根结点不是终端结点，则至少有两颗子树

3. 除根结点外的所有非外部结点至少有 ceil(m/2) 棵子树，即至少含有 ceil(m/2) - 1 个关键字（ceil向上取整）

4. 所有的非叶结点的结构如下

   ![image-20220320110711248](C:\Users\Zhongbf\AppData\Roaming\Typora\typora-user-images\image-20220320110711248.png)

   其中 K~i~（i=1,2,...,n）为结点的关键字，且满足K~1~ < K~2~ < ..... < K~n~；P~i~（i=0,1,...,n）;为指向子树根结点的指针，且指针P~i-1~所指子树中所有结点的关键字均小于K~i~,P~i~所指子树中所有结点的关键字均大于K~i~，n是结点中关键字的个数（ceil(m/2) - 1 ≤ n ≤ m - 1）

5. 所有的外部结点都出现在同一层次上，外部结点层并不带任何信息，B树是所有结点的平衡因子均等于0的多路查找树，在计算B树的高度时，需要计入最底层的外部结点



一棵3阶的B树：

- 非根非外部结点的关键字个数：ceil(m/2) - 1 ≤ n ≤ m - 1（1 ≤ n ≤ 2）
- 非根非外部节点的孩子结点个数：2或3

> 说明：外部结点就是失败结点，指向它的指针为空，不含有任何信息，是虚设的。一棵B树中总有 n 个关键字，则外部结点个数为 n+1

![image-20220320132332731](C:\Users\Zhongbf\AppData\Roaming\Typora\typora-user-images\image-20220320132332731.png)

#### 1.2 B树的数据类型定义

```

```

#### 1.3 B树的查找

将 k 与根结点中的key[i]进行比较：

①若k=key[i]，则查找成功

②若k＜key[1]，则沿着指针ptr[0]所指的子树继续查找

③若key[i]＜k＜key[i+1]，则沿着指针ptr[i]所指的子树继续查找

④若k＞key[n]，则沿着指针ptr[n]所指的子树继续查找

> 说明：在B树中找结点（在磁盘），在结点中找关键字（在内存），当查找到某个叶结点时，若相应的指针为空，落入一个外部结点，表示查找失败。



#### 1.3 B树的插入

将关键字 k 插入到B树的过程分两步完成：

1. 查找该关键字的插入结点（`注意B树的插入结点一定一叶子节点层的结点`）

   - ①插入结点有空位置，即关键字个数 n＜m-1：直接把关键字k有序插入到该结点的合适位置上

   - ②插入结点没有空位置，即原关键字个数n=m-1——分裂

     - 分裂过程：

     ![image-20220320141324260](C:\Users\Zhongbf\AppData\Roaming\Typora\typora-user-images\image-20220320141324260.png)

     - 如果没有双亲结点，新建一个双亲结点，如果有双亲结点，将 k~i~ 插入到双亲结点中

#### 1.4 B树的删除

在B树上删除关键字k的过程分两步完成：

1. 查找关键字 k 所在的结点
2. 删除关键字 k

删除关键字 k 分两种情况：

- 在叶子结点层上删除关键字
- 在非叶子结点层上删除关键字k

> 注意：在非根、非叶子的关键字最少个数Min=ceil(m/2)-1



在B树的叶子结点b上删除关键字共有3种情况：

1）假如 b 结点的关键字个数大于 Min，说明删去该关键字后该结点仍满足B树的定义，则课直接删去该关键字

![image-20220320142607393](C:\Users\Zhongbf\AppData\Roaming\Typora\typora-user-images\image-20220320142607393.png)

2）假如 b 结点的关键字个数等于Min，说明删去关键字后该结点将不满足B树的定义。从兄弟结点借

3）假如不能从兄弟结点借，合并



## 二、B+树 

B+树是B树的一些变形。一棵4阶的B+树示例：

![image-20220320144416704](C:\Users\Zhongbf\AppData\Roaming\Typora\typora-user-images\image-20220320144416704.png)

B+树的定义

一棵m阶B+树满足下列要求：

- 每个分支结点至多有m棵子树（例子：m=4）
- 根结点或者没有子树，或者至少有两个子树
- 除根结点外，其他每个分支结点至少有 ceil(m/2) 棵子树
- 有n棵子树的结点恰好有n个关键字
- 所有叶子结点包含全部关键字及指向相应记录的指针，而且叶子结点按关键字大小顺序连接。并将所有叶子结点连接起来
- 所有分支结点（可看成索引的索引）中仅包含它的各个子结点中最大关键字及指向子结点的指针



B树相对于平衡二叉树的不同是，每个节点包含的关键字增多了，特别是在B树应用到数据库中的时候，数据库充分利用了磁盘块的原理（磁盘数据存储是采用块的形式存储的，每个块的大小为4K，每次IO进行数据读取时，同一个磁盘块的数据可以一次性读取出来）把节点大小限制和充分使用在磁盘快大小范围；把树的节点关键字增多后树的层级比原来的二叉树少了，减少数据查找的次数和复杂度;



#### 2.1 B+树的查找

![image-20220320150031801](C:\Users\Zhongbf\AppData\Roaming\Typora\typora-user-images\image-20220320150031801.png)



## 三、B树和B+树的比较

1. B+树的层级更少：相较于B树B+每个非叶子节点存储的关键字数更多，树的层级更少所以查询数据更快；
2. B+树查询速度更稳定：B+所有关键字数据地址都存在叶子节点上，所以每次查找的次数都相同所以查询速度要比B树更稳定
3. B+树天然具备排序功能：B+树所有的叶子节点数据构成了一个有序链表，在查询大小区间的数据时候更方便，数据紧密性很高，缓存的命中率也会比B树高
4. B+树全节点遍历更快：B+树遍历整棵树只需要遍历所有的叶子节点即可，，而不需要像B树一样需要对每一层进行遍历，这有利于数据库做全表扫描



B树的优点：

B树相对于B+树的优点是，如果经常访问的数据离根节点很近（就是数据量少，层级不多的时候），而B树的非叶子节点本身存有关键字其数据的地址，所以这种数据检索的时候会要比B+树快