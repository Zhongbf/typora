# MySQL 军规

## 1. 基础规范

- 表存储引擎必须使用InnoDB
- 表字符集默认使用`utf8`,必要时候使用utf8mb4
  - 通用，无乱码风险，汉字3字节，英文1字节
  - `utf8mb4`是`utf8`的超集，有存储4字节例如表情符号时，使用它

- 禁止使用存储过程，视图，触发器，Event
  - 对数据库性能影响较大，互联网业务，能让站点层和服务层干的事情，不要交到数据库层
  - 调式、排错、迁移都比较困难，扩展性较差
- 禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统，数据库中存储路径

- 禁止在线上环境做数据库压力测试
- 测试、开发，线上数据库环境必须隔离

## 2. 命名规范

- 库名、表名、列名必须用用小写，采用下划线分隔（tb_book）
  - abc，Abc，ABC都是给自己埋坑

- 库名、表名、列名必须有语义，长度不要超过32个字符 
- tmp，wushan 谁TM知道这些库时干嘛的
- 库备份必须以bak为前缀，以日期为后缀
- 从库必须以`-s`为后缀
- 备库必须以`-ss`为后缀 

## 3. 表设计规范

- 单实例表个数必须控制在`2000`个以内
- 单表分表个数必须控制在`1024`g个以内
- 表必须有主键，推荐使用`UNSIGNED`整数为主键
  - 删除无主键的表，如果时`row`模式的主从架构，从库会挂住
- 禁止使用物理外键，如果要保证完整性，应由应用程序实现
  - 外键使得表之间相互耦合，影响`update/delete`等SQL性能，有可能造成死锁，高并发情况下容易成为数据库瓶颈
- 建议将大字段，访问频率低的字段拆分到单独的表中存储，分离冷热数据

## 4. 列设计规范

- 根据业务区分使用`tinyint/int/bigint`，分别会占用`1/4/8`字节
- 根据业务区分使用`char/varchar`
  - 字段长度固定，或者长度近似的业务场景，适合使用`char`，能够减少碎片，查询性能高
  - 字段长度相差较大，或者更新较少的业务场景，适合使用`varchar`，能够减少空间

- 根据业务区分使用`datetime/timestamp`
  - 前者占用5个字节，后者占用4个字节，存储年使用`TEAR`，存储日期使用`DATE`，存储时间使用`datetime`
- 必须把字段定义为`NOT NULL`，并设默认值
  - NULL的列使用索引，索引统计，值都是更加复杂，MySQL更难优化
  - NULL需要更多的存储空间
  - NULL只能采用`IS NULL`或者`IS NOT NULL`，而在`=/!=/in/not in`时有大坑
- 使用`INT UNSIGNED`存储`IPv4`，不要用`char(15)`
- 使用`varchar(20)`存储手机号，不要使用整数
  - 牵扯到国家代号，可能出现`+/-/()`等字符，例如`+86`
  - 手机号不会用来做数学运算
  - `varchar`可以模糊查询，例如`like‘138%’`
- 使用`TINYINT`来代替`ENUM`
  - `ENUM`增加新值要进行`DDL`操作

## 5. 索引规范

- 唯一索引使用`uniq_[字段名]`来命名
- 非唯一索引使用`idx_[字段名]`来命名
- 单张表索引数量建议控制在5个以内
  - 互联网高并发业务，太多索引会影响写性能
  - 生成执行计划时，如果索引太多，会降低性能，并可能导致MySQL选择不到最优索引
  - 异常复杂的查询需求，可以选择`ES`等更为适合的方式存储
- 组合索引字段数不建议超过5个
  - 如果5个字段还不能极大缩小row范围，八成时设计有问题
- 不建议在频繁更新的字段上建立索引
- 非必要不要进行`JOIN`查询，如果要进行`JOIN`查询，被`JOIN`的字段必须类型相同，并建立索引
  - 踩过因为`JOIN`字类型不一致，而导致全表扫描的坑么？
- 理解组合索引最左前缀法则，避免重复键索引，如果建立了(a.b.c)，相当于建立了(a)、(a,b)、(a,b,c)

## 6. SQL规范

- 禁止使用`select *`，只获取必要字段
  - `select *`会增加CPU/IO/内存/带宽的消耗
  - 指定字段能有效利用索引覆盖
  - 指定字段查询，在表结构变更时，能保证对应用程序无影响
- `insert`必须指定字段，禁止使用`insert into T values()`
  - 指定字段插入，在表结构变更时，能保证对应用程序无影响
- 隐式类型转换会使索引失效，导致全表扫描
- 禁止在where条件列使用函数或者表达式
  - 导致不能命中索引，全表扫描
- 禁止负向查询以及%开头的模糊查询
  - 导致不能命中索引，全表扫描
- 禁止大表JOIN和子查询
- 同一个字段上的OR必须改写问IN，IN的值必须少于50个
- 应用程序必须捕获SQL异常
  - 方便定位线上问题